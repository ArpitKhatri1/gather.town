<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Server-Authoritative Player (200x200)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; display:flex; gap:20px; padding:20px; }
    #game { border: 2px solid #222; background:#f8f8f8; }
    #ui { min-width:220px; }
    .status { margin-bottom: 8px; }
    .legend { margin-top: 10px; font-size: 13px; color:#444; }
    .dot { display:inline-block; width:12px; height:12px; border-radius:6px; margin-right:6px; vertical-align:middle; }
  </style>
</head>
<body>
  <canvas id="game" width="200" height="200"></canvas>

  <div id="ui">
    <div class="status"><strong>Connection:</strong> <span id="conn">connecting...</span></div>
    <div><strong>Controls</strong>
      <div>Arrow keys or WASD — hold to move</div>
    </div>

    <div class="legend">
      <div><span class="dot" style="background:#1f77b4"></span> All players (server state)</div>
    </div>

    <div style="margin-top:12px;">
      <div><strong>Players received:</strong> <span id="count">0</span></div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const connEl = document.getElementById('conn');
  const countEl = document.getElementById('count');

  const BOARD_W = 200;
  const BOARD_H = 200;

  const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = wsProtocol + '//' + location.host + '/ws';
  const socket = new WebSocket(wsUrl);

  let latestServerState = [];

  socket.addEventListener('open', () => {
    connEl.textContent = 'connected';
    connEl.style.color = 'green';
  });

  socket.addEventListener('close', () => {
    connEl.textContent = 'disconnected — retrying...';
    connEl.style.color = 'crimson';
    setTimeout(() => location.reload(), 1500); // simple reconnect
  });

  socket.addEventListener('message', (ev) => {
    try {
      const payload = JSON.parse(ev.data);
      if (Array.isArray(payload)) {
        latestServerState = payload.map(p => ({ x: Number(p.x), y: Number(p.y) }));
        countEl.textContent = latestServerState.length;
      }
    } catch (err) {
      console.warn('failed to parse server message', err, ev.data);
    }
  });

  const keys = { up:false, down:false, left:false, right:false };
  const SEND_MS = 50;

  function computeDxDy() {
    return {
      dx: Math.max(-1, Math.min(1, (keys.right?1:0) + (keys.left?-1:0))),
      dy: Math.max(-1, Math.min(1, (keys.down?1:0) + (keys.up?-1:0)))
    };
  }

  setInterval(() => {
    if (socket.readyState === WebSocket.OPEN) {
      const { dx, dy } = computeDxDy();
      if (dx !== 0 || dy !== 0) {
        socket.send(JSON.stringify({ dx, dy }));
      }
    }
  }, SEND_MS);

  window.addEventListener('keydown', e => {
    if (e.key==='ArrowUp'||e.key==='w'||e.key==='W') keys.up=true;
    if (e.key==='ArrowDown'||e.key==='s'||e.key==='S') keys.down=true;
    if (e.key==='ArrowLeft'||e.key==='a'||e.key==='A') keys.left=true;
    if (e.key==='ArrowRight'||e.key==='d'||e.key==='D') keys.right=true;
  });

  window.addEventListener('keyup', e => {
    if (e.key==='ArrowUp'||e.key==='w'||e.key==='W') keys.up=false;
    if (e.key==='ArrowDown'||e.key==='s'||e.key==='S') keys.down=false;
    if (e.key==='ArrowLeft'||e.key==='a'||e.key==='A') keys.left=false;
    if (e.key==='ArrowRight'||e.key==='d'||e.key==='D') keys.right=false;
  });

  function draw() {
    ctx.clearRect(0,0,BOARD_W,BOARD_H);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,BOARD_W,BOARD_H);

    // draw all players from server state
    ctx.fillStyle = '#1f77b4';
    for (const p of latestServerState) {
      ctx.beginPath();
      ctx.arc(p.x + 0.5, p.y + 0.5, 4, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(draw);
  }

  draw();
})();
</script>
</body>
</html>
